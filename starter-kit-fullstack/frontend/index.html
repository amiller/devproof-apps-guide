<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Devproof — Encrypted KV Store</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0 }
  body { font-family: system-ui, sans-serif; max-width: 560px; margin: 3rem auto; padding: 0 1rem; color: #222; line-height: 1.5 }
  h1 { font-size: 1.3rem; margin-bottom: .2rem }
  h2 { font-size: 1rem; margin: 1.5rem 0 .4rem; color: #555 }
  input, button { font-size: .9rem; padding: .5rem .7rem }
  input[type=text] { width: 100%; border: 1px solid #ccc; border-radius: 6px }
  button { background: #222; color: #fff; border: none; border-radius: 6px; cursor: pointer; transition: background .15s }
  button:hover { background: #444 }
  button:disabled { opacity: .5 }
  pre { background: #f5f5f5; padding: .8rem; border-radius: 6px; overflow-x: auto; font-size: .8rem; white-space: pre-wrap; word-break: break-all; user-select: all; margin: .5rem 0 }
  .row { display: flex; gap: .5rem; margin-bottom: .5rem }
  .row input { flex: 1 }
  .stats { display: flex; gap: 1.5rem; font-size: .85rem; color: #888; margin: .8rem 0 }
  .stats .n { font-weight: 700; font-size: 1.1rem; color: #222 }
  .sub { font-size: .85rem; color: #888 }
  .sep { border: none; border-top: 1px solid #eee; margin: 1.5rem 0 }
  a { color: #47e }
  .check { color: #2a2 } .fail { color: #c22 }
  .nav { display: flex; gap: 1rem; font-size: .85rem; margin-top: .5rem }
  .records { margin-top: .5rem }
  .record { display: flex; gap: .5rem; padding: .4rem 0; border-bottom: 1px solid #f0f0f0; font-size: .85rem; cursor: pointer }
  .record:hover { background: #fafafa }
  .record .k { font-weight: 600; min-width: 100px }
  .record .v { color: #666; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap }
  .record .cipher { color: #bbb; font-size: .75rem; font-family: monospace }
  .quick { display: flex; gap: .5rem; flex-wrap: wrap; margin: .5rem 0 }
  .quick button { background: #f0f0f0; color: #222; font-size: .8rem; padding: .3rem .6rem }
  .quick button:hover { background: #e0e0e0 }
</style>
</head><body>

<h1>Devproof</h1>
<p class="sub">Encrypted KV store backed by a TEE. Values never leave the enclave unencrypted.</p>
<div class="nav">
  <a href="/docs">API Docs</a>
  <a href="https://github.com/amiller/devproof-toy" target="_blank">Source</a>
  <a href="/api/verify" target="_blank">Verify TEE</a>
</div>

<div class="stats" id="globalStats"></div>

<div class="quick">
  <button onclick="storeRandom()">Store a random secret</button>
  <button onclick="storeBtcPrice()">Store BTC price</button>
  <button onclick="storeTimestamp()">Store timestamp</button>
</div>

<h2>Your records</h2>
<div class="records" id="recordsList"><span class="sub">Loading...</span></div>

<hr class="sep">

<h2>Store / Lookup</h2>
<div class="row">
  <input type="text" id="recKey" placeholder="key">
  <input type="text" id="recValue" placeholder="value">
</div>
<div class="row">
  <button onclick="storeRecord()" style="flex:1">Store</button>
  <button onclick="lookupRecord()" style="flex:1;background:#555">Lookup</button>
</div>
<pre id="recResult" style="display:none"></pre>

<hr class="sep">

<h2>TLS Oracle</h2>
<p class="sub">Fetch any HTTPS URL through the TEE with signed attestation.</p>
<div class="row">
  <input type="text" id="targetUrl" value="https://api.coinbase.com/v2/prices/BTC-USD/spot">
  <button id="fetchBtn" onclick="doFetch()">Fetch</button>
</div>
<div id="result" style="display:none">
  <div style="font-size:.8rem;color:#888;margin-bottom:.3rem">
    <span id="rFingerprint"></span> &middot; <span id="rTimestamp"></span>
  </div>
  <pre id="rBody"></pre>
  <div id="verification" style="font-size:.8rem"></div>
</div>

<div class="sub" id="sessionStatus" style="margin-top:1.5rem"></div>

<input type="hidden" id="cvmUrl" value="https://fffd093b00ce84a2708706ce61510913d7333dcf-8080.dstack-pha-prod7.phala.network">

<script type="module">
import { secp256k1 } from 'https://esm.sh/@noble/curves@1.8.1/secp256k1'
import { keccak_256 } from 'https://esm.sh/@noble/hashes@1.7.1/sha3'
import { sha256 } from 'https://esm.sh/@noble/hashes@1.7.1/sha256'

let token = null
const cvm = () => document.getElementById('cvmUrl').value
const show = (data) => { const el = document.getElementById('recResult'); el.style.display = 'block'; el.textContent = JSON.stringify(data, null, 2) }

const adjectives = ['secret','hidden','private','encrypted','sealed','classified','covert','arcane']
const nouns = ['message','note','password','key','token','code','cipher','memo']
const phrases = ['the eagle has landed','trust no one','42 is the answer','all your base','hello world','rosebud','open sesame','the cake is a lie']
const pick = arr => arr[Math.floor(Math.random() * arr.length)]

;(async () => {
  let res = await fetch('/api/session', { credentials: 'include' })
  if (!res.ok) res = await fetch('/api/session', { method: 'POST', credentials: 'include' })
  const d = await res.json()
  document.getElementById('sessionStatus').textContent = `session ${d.userId}`
  token = (await (await fetch('/api/token', { method: 'POST' })).json()).token
  refreshStats()
  refreshRecords()
})()

async function refreshStats() {
  try {
    const s = await (await fetch(`${cvm()}/stats`)).json()
    document.getElementById('globalStats').innerHTML =
      `<div><span class="n">${s.totalUsers ?? '?'}</span> users</div>` +
      `<div><span class="n">${s.totalRecords ?? '?'}</span> records</div>` +
      `<div>up ${s.uptime}</div>`
  } catch {}
}

async function refreshRecords() {
  try {
    const res = await fetch('/api/records', { credentials: 'include' })
    const d = await res.json()
    const el = document.getElementById('recordsList')
    if (!d.records?.length) { el.innerHTML = '<span class="sub">No records yet. Try storing one!</span>'; return }
    el.innerHTML = d.records.map(r =>
      `<div class="record" onclick="document.getElementById('recKey').value='${r.key}';lookupRecord()">` +
      `<span class="k">${r.key}</span>` +
      `<span class="cipher">${r.ciphertext.substring(0, 40)}...</span>` +
      `</div>`
    ).join('')
  } catch {}
}

async function doStore(key, value) {
  await fetch('/api/records', { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key, value }) })
  refreshStats()
  refreshRecords()
  document.getElementById('recKey').value = key
  document.getElementById('recValue').value = value
  // auto-lookup to show the decrypted value
  const res = await fetch(`/api/records?key=${encodeURIComponent(key)}`, { credentials: 'include' })
  show(await res.json())
}

window.storeRandom = () => doStore(`${pick(adjectives)}-${pick(nouns)}`, pick(phrases))

window.storeBtcPrice = async function() {
  try {
    const r = await fetch(`${cvm()}/fetch`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ url: 'https://api.coinbase.com/v2/prices/BTC-USD/spot' }) })
    const d = await r.json()
    const price = JSON.parse(d.body)?.data?.amount || d.body
    doStore('btc-price', `$${price} @ ${d.timestamp}`)
  } catch(e) { alert(e.message) }
}

window.storeTimestamp = () => doStore('timestamp', new Date().toISOString())

window.storeRecord = async function() {
  const key = document.getElementById('recKey').value, value = document.getElementById('recValue').value
  if (!key) return
  await doStore(key, value)
}

window.lookupRecord = async function() {
  const key = document.getElementById('recKey').value
  if (!key) return
  const res = await fetch(`/api/records?key=${encodeURIComponent(key)}`, { credentials: 'include' })
  show(await res.json())
}

window.doFetch = async function() {
  const btn = document.getElementById('fetchBtn')
  btn.disabled = true; btn.textContent = 'Fetching...'
  try {
    const res = await fetch(`${cvm()}/fetch`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ url: document.getElementById('targetUrl').value }) })
    const data = await res.json()
    if (data.error) throw new Error(data.error)
    document.getElementById('result').style.display = 'block'
    document.getElementById('rFingerprint').textContent = data.tlsFingerprint || ''
    document.getElementById('rTimestamp').textContent = data.timestamp
    document.getElementById('rBody').textContent = data.body?.substring(0, 2000)
    verify(data)
    refreshStats()
  } catch(e) { alert('Error: ' + e.message) }
  finally { btn.disabled = false; btn.textContent = 'Fetch' }
}

async function verify(data) {
  const el = document.getElementById('verification')
  const checks = []
  const expected = bytesToHex(sha256(data.url + data.body + (data.tlsFingerprint || '') + data.timestamp))
  checks.push({ label: 'Hash', ok: expected === data.hash })
  checks.push({ label: 'TDX quote', ok: !!data.quote })
  checks.push({ label: 'Sig chain', ok: data.signatureChain?.length > 0 })
  try {
    const metaHtml = (await (await fetch(cvm() + '/metadata')).text()).replace(/&#(\d+);/g, (_, n) => String.fromCharCode(n))
    const m = metaHtml.match(/"compose_hash":\s*"([a-f0-9]+)"/)
    if (m) checks.push({ label: 'Source', ok: true, detail: `<a href="https://github.com/amiller/devproof-toy/commit/${m[1]}" target="_blank">${m[1].substring(0, 8)}</a>` })
  } catch {}
  el.innerHTML = checks.map(c => `<span class="${c.ok ? 'check' : 'fail'}" style="margin-right:.6rem">${c.ok ? '✓' : '✗'} ${c.label}${c.detail ? ' ' + c.detail : ''}</span>`).join('')
}

function hexToBytes(h) { h = h.replace(/^0x/, ''); const b = new Uint8Array(h.length / 2); for (let i = 0; i < b.length; i++) b[i] = parseInt(h.substr(i * 2, 2), 16); return b }
function bytesToHex(b) { return typeof b === 'string' ? b : Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2, '0')).join('') }
</script>
</body></html>
